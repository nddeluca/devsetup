name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Sync uv
        run: uv sync --frozen

      - name: Run linters
        run: make lint

  tests:
    runs-on: ubuntu-latest

    env:
      # Makefile knobs for buildx + caching
      # In your Makefile:
      #   DOCKER ?= docker
      #   DOCKER_BUILD ?= $(DOCKER) buildx build
      #   DOCKER_BUILD_EXTRA_ARGS ?= --load
      #
      # These env vars extend DOCKER_BUILD_EXTRA_ARGS in CI to enable cache.
      DOCKER_BUILD_EXTRA_ARGS: >-
        --load
        --cache-from type=gha,scope=debian-tester
        --cache-to type=gha,scope=debian-tester,mode=max

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run tests (Dockerized Debian host)
        run: make test
